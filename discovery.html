<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNYone - Discovery</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; margin: 0; padding: 15px; }
        .tab-bar { display: flex; justify-content: space-around; background: #1e293b; padding: 12px; border-radius: 12px; margin-bottom: 20px; }
        .tab { cursor: pointer; color: #94a3b8; font-weight: bold; font-size: 14px; }
        .tab.active { color: #00dbde; border-bottom: 2px solid #00dbde; }
        
        .user-card { background: #1e293b; padding: 15px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; border: 1px solid #334155; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; background: linear-gradient(45deg, #475569, #1e293b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-request { background: #00dbde; color: #0f172a; }
        .btn-accept { background: #22c55e; color: white; }
        .btn-pending { background: #475569; color: #94a3b8; cursor: default; }
    </style>
</head>
<body>

<div style="margin-bottom: 20px;">
    <a href="chat.html" style="color: #94a3b8; text-decoration: none;"><i class="fa fa-arrow-left"></i> Back to Chat</a>
</div>

<div class="tab-bar">
    <div id="tab-explore" class="tab active" onclick="showSection('explore')">Find Friends</div>
    <div id="tab-requests" class="tab" onclick="showSection('requests')">Requests</div>
</div>

<div id="section-explore">
    <h3 style="font-size: 16px; margin-bottom: 15px; color: #94a3b8;">People on VNYone</h3>
    <div id="global-users-list">Loading people...</div>
</div>

<div id="section-requests" style="display: none;">
    <h3 style="font-size: 16px; margin-bottom: 15px; color: #94a3b8;">Incoming Requests</h3>
    <div id="incoming-requests-list">No pending requests.</div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAq67c32Oz1wgTEqbmZStWsbNuJ2UTqgzc",
        authDomain: "vnyone-1.firebaseapp.com",
        projectId: "vnyone-1",
        storageBucket: "vnyone-1.firebasestorage.app",
        messagingSenderId: "353061173666",
        appId: "1:353061173666:web:022b7015e116ff4b055afb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const myName = localStorage.getItem('vnyUserName') || "Guest";

    function showSection(type) {
        document.getElementById('section-explore').style.display = type === 'explore' ? 'block' : 'none';
        document.getElementById('section-requests').style.display = type === 'requests' ? 'block' : 'none';
        document.getElementById('tab-explore').classList.toggle('active', type === 'explore');
        document.getElementById('tab-requests').classList.toggle('active', type === 'requests');
    }

    // 1. SHOW ALL USERS (Global List)
    async function loadGlobalUsers() {
        const list = document.getElementById('global-users-list');
        const snap = await db.collection("users").get(); // Sab users ko fetch karna
        list.innerHTML = "";

        snap.forEach(doc => {
            const user = doc.data();
            if(user.username !== myName) { // Khud ko list mein nahi dikhana
                list.innerHTML += `
                    <div class="user-card">
                        <div class="user-info">
                            <div class="avatar"><i class="fa fa-user"></i></div>
                            <div><b>${user.username}</b><br><small style="color:#94a3b8;">${user.bio || 'VNYone Member'}</small></div>
                        </div>
                        <button class="btn btn-request" id="btn-${user.username}" onclick="sendReq('${user.username}')">Request</button>
                    </div>`;
            }
        });
    }

    // 2. SEND REQUEST
    function sendReq(target) {
        db.collection("requests").add({
            from: myName,
            to: target,
            status: "pending",
            time: firebase.firestore.FieldValue.serverTimestamp()
        });
        const btn = document.getElementById('btn-' + target);
        btn.innerText = "Sent";
        btn.className = "btn btn-pending";
        btn.disabled = true;
    }

    // 3. LISTEN FOR MY REQUESTS
    db.collection("requests").where("to", "==", myName).where("status", "==", "pending")
    .onSnapshot(snap => {
        const list = document.getElementById('incoming-requests-list');
        list.innerHTML = snap.empty ? "No new requests." : "";
        snap.forEach(doc => {
            const req = doc.data();
            list.innerHTML += `
                <div class="user-card">
                    <div class="user-info">
                        <div class="avatar"><i class="fa fa-user"></i></div>
                        <div><b>${req.from}</b> sent you a request</div>
                    </div>
                    <button class="btn btn-accept" onclick="acceptReq('${doc.id}', '${req.from}')">Accept</button>
                </div>`;
        });
    });

    async function acceptReq(id, sender) {
        await db.collection("requests").doc(id).update({ status: "accepted" });
        alert("You are now connected with " + sender);
        // Yahan aap 'friends' collection mein bhi data daal sakte ho
    }

    loadGlobalUsers();
</script>
</body>
</html>
